---
# These tasks installs redmine

- name: install system packages required for redmine
  apt: pkg={{ item }} state=present
  sudo: yes
  with_items:
    - imagemagick
    - libmagickwand-dev
    - libxslt1-dev 
    - libxml2-dev

- name: install unzip
  apt: pkg=unzip state=present
  sudo: yes

- name: clone redmine repository
  git: repo=git://github.com/redmine/redmine.git dest={{ redmine_dir }} version=2.3-stable

- name: set redmine repository permissions
  file: dest={{ redmine_dir }} owner=redmine_adm group=redmine mode=755 recurse=yes state=directory 
  sudo: yes
  tags: 
    - perms

- name: create directories accessible by webserver / set permissions
  file: path={{ redmine_dir }}/{{ item }} owner=redmine group=redmine_adm mode=2770 recurse=yes state=directory
  with_items:
    - public/plugin_assets
    - log
    - tmp
    - files
  sudo: yes
  tags:
    - perms

- name: create database config file
  template: src=database.yml.j2 dest={{ redmine_dir }}/config/database.yml group=redmine mode=640

- name: remove nokogiri gem from Gemfile (problems with plugins)
  lineinfile: dest={{ redmine_dir }}/Gemfile state=absent
    regexp='^\s*gem .nokogiri.'
  tags: noko

- name: run redmine bundle update
  command: chdir={{ redmine_dir }} bundle update

- name: run redmine bundle install 
  command: chdir={{ redmine_dir }} bundle install --without test

- name: generate secret rails token
  command: chdir={{ redmine_dir }} rake generate_secret_token

- name: migrate database
  command: chdir={{ redmine_dir }} rake db:migrate RAILS_ENV=production

- name: load default data
  command: chdir={{ redmine_dir }} 
    rake redmine:load_default_data REDMINE_LANG=de RAILS_ENV=production
  notify:
    - restart nginx


# vim: set filetype=yaml sw=2 ts=2 sts=2 expandtab:

